{
  "name": "Meme Generator 6",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 17
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.3,
      "position": [
        144,
        -320
      ],
      "id": "647e9d26-c535-4638-96a2-fe4cc569b598",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "jsCode": "/**\n * ğŸš€ ä¿®æ­£ç‰ˆï¼šè‡ªå‹•é©é… Google Drive åˆ—è¡¨è¼¸å‡ºæ ¼å¼\n */\n\n// 1. åˆå§‹åŒ–è®Šé‡\nconst allInputs = $input.all();\nlet files = [];\n\nconsole.log(`æ”¶åˆ° ${allInputs.length} å€‹è¼¸å…¥é …ç›®`);\n\ntry {\n    // ğŸ” ç­–ç•¥ A: æª¢æŸ¥ç¬¬ä¸€å€‹é …ç›®çš„ json å…§æ˜¯å¦æœ‰ files é™£åˆ— (é€™æ˜¯ä½ ç›®å‰çš„ç‹€æ³)\n    if (allInputs[0].json && Array.isArray(allInputs[0].json.files)) {\n        files = allInputs[0].json.files;\n        console.log(\"åµæ¸¬åˆ°æ ¼å¼ï¼šStandard Google Drive List (files array)\");\n    } \n    // ğŸ” ç­–ç•¥ B: æª¢æŸ¥è¼¸å…¥æœ¬èº«æ˜¯å¦å°±æ˜¯å¤šå€‹ç¨ç«‹é …ç›® (å¦‚æœä¹‹å‰ç”¨äº† Item Lists ç¯€é»)\n    else if (allInputs.length > 1) {\n        files = allInputs.map(item => item.json);\n        console.log(\"åµæ¸¬åˆ°æ ¼å¼ï¼šSplit Items (multiple n8n items)\");\n    }\n    // ğŸ” ç­–ç•¥ C: æª¢æŸ¥ json æœ¬èº«æ˜¯å¦ç‚ºé™£åˆ—\n    else if (Array.isArray(allInputs[0].json)) {\n        files = allInputs[0].json;\n        console.log(\"åµæ¸¬åˆ°æ ¼å¼ï¼šSimple Array\");\n    }\n\n    // 2. å¦‚æœé‚„æ˜¯æ‰¾ä¸åˆ° filesï¼Œæ‹‹å‡ºéŒ¯èª¤\n    if (!files || files.length === 0) {\n        throw new Error(\"æ‰¾ä¸åˆ°ä»»ä½•æª”æ¡ˆæ•¸æ“šï¼Œè«‹æª¢æŸ¥ Google Drive ç¯€é»è¼¸å‡º\");\n    }\n\n    // 3. éæ¿¾åœ–ç‰‡ä¸¦æ’é™¤å·²ç”Ÿæˆçš„ Meme\n    const validImages = files.filter(file => {\n        const isImage = file.mimeType && file.mimeType.startsWith('image/');\n        const isNotMeme = file.name && !file.name.toLowerCase().startsWith('meme_');\n        const isNotFolder = file.mimeType !== 'application/vnd.google-apps.folder';\n        return isImage && isNotMeme && isNotFolder;\n    });\n\n    console.log(`éæ¿¾å¾Œå‰©ä¸‹ ${validImages.length} å€‹æœ‰æ•ˆåœ–ç‰‡`);\n\n    if (validImages.length === 0) {\n        return [{ json: { error: \"æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„åŸå§‹åœ–ç‰‡ (å·²æ’é™¤ meme_ é–‹é ­çš„æª”æ¡ˆ)\" } }];\n    }\n\n    // 4. éš¨æ©Ÿæˆ–æŒ‰é †åºå–å‰ 3 å€‹ï¼Œä¸¦ç”Ÿæˆæ­£ç¢ºçš„ URL\n    // æ³¨æ„ï¼šGoogle Drive ç›´æ¥é€£çµéœ€è¦æª”æ¡ˆè¨­ç‚ºã€ŒçŸ¥é“é€£çµçš„äººå‡å¯æŸ¥çœ‹ã€\n    const results = validImages.slice(0, 3).map((file, index) => {\n        return {\n            json: {\n                id: file.id,\n                fileId: file.id,\n                name: file.name,\n                mimeType: file.mimeType,\n                // ä¸‹é¢é€™å€‹ URL æ˜¯ä¾›å¤–éƒ¨æœå‹™ï¼ˆå¦‚ Ollama/ImgBBï¼‰å˜—è©¦æŠ“å–\n                photoUrl: `https://drive.google.com/uc?export=view&id=${file.id}`,\n                downloadUrl: `https://drive.google.com/uc?export=download&id=${file.id}`,\n                index: index,\n                processedAt: new Date().toISOString()\n            }\n        };\n    });\n\n    return results;\n\n} catch (err) {\n    console.error(\"è…³æœ¬åŸ·è¡Œå¤±æ•—:\", err.message);\n    return [{ json: { error: err.message, stack: err.stack } }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1024,
        -320
      ],
      "id": "b7b2f2a9-5acd-421d-afca-0839741ac6d1",
      "name": "Code in JavaScript"
    },
    {
      "parameters": {
        "type": "random"
      },
      "type": "n8n-nodes-base.sort",
      "typeVersion": 1,
      "position": [
        1456,
        -320
      ],
      "id": "5389686a-855b-4a1c-a2e1-f8996a417d01",
      "name": "Sort"
    },
    {
      "parameters": {
        "maxItems": 10
      },
      "type": "n8n-nodes-base.limit",
      "typeVersion": 1,
      "position": [
        1680,
        -320
      ],
      "id": "31f655c9-32ab-4654-b779-23c78fd94971",
      "name": "Limit"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "name": "Replace Me",
      "typeVersion": 1,
      "position": [
        2320,
        -32
      ],
      "id": "1bf00748-db96-4950-89d0-c63ef77f2a3e"
    },
    {
      "parameters": {
        "jsCode": "// ============================================\n// ç¯€é»åç¨±ï¼šCode in JavaScript1 (æº–å‚™ AI æ•¸æ“š)\n// ä½ç½®ï¼šLoop Over Items â†’ é€™å€‹ç¯€é» â†’ HTTP Request2 (Ollama Vision)\n// ä½œç”¨ï¼šç¢ºä¿å‚³çµ¦ Ollama çš„åœ–ç‰‡é€£çµæœ‰æ•ˆ\n// ============================================\n\nconsole.log(\"=== æº–å‚™æ•¸æ“šçµ¦ Ollama Vision ===\");\n\n// æª¢æŸ¥é—œéµæ¬„ä½\nif (!$json.photoUrl) {\n  console.error(\"âŒ éŒ¯èª¤ï¼šphotoUrl ç‚ºç©º\");\n  console.log(\"ç•¶å‰æ•¸æ“š:\", JSON.stringify($json, null, 2));\n  \n  // å˜—è©¦ä½¿ç”¨ baseUrl ä½œç‚ºå‚™ç”¨\n  if ($json.baseUrl) {\n    console.log(\"âš ï¸ ä½¿ç”¨ baseUrl ä½œç‚ºå‚™ç”¨\");\n    return {\n      ...$json,\n      photoUrl: $json.baseUrl,\n      usingFallback: true\n    };\n  }\n  \n  // å¦‚æœéƒ½æ²’æœ‰ï¼Œè¿”å›éŒ¯èª¤æ¨™è¨˜\n  return {\n    ...$json,\n    error: \"æ²’æœ‰æœ‰æ•ˆçš„åœ–ç‰‡é€£çµ\",\n    meme_score: 0\n  };\n}\n\n// é©—è­‰é€£çµæ ¼å¼\nconsole.log(`åœ–ç‰‡é€£çµ: ${$json.photoUrl}`);\nconsole.log(`æª”æ¡ˆåç¨±: ${$json.name}`);\n\n// å¦‚æœæ˜¯ Google Drive é€£çµï¼Œç¢ºä¿æ˜¯æ­£ç¢ºæ ¼å¼\nif ($json.photoUrl.includes('drive.google.com')) {\n  console.log(\"âš ï¸ Google Drive é€£çµï¼Œæª¢æŸ¥æ ¼å¼...\");\n  \n  // æ‡‰è©²æ˜¯ç¸®åœ–æ ¼å¼ï¼Œä¸æ˜¯ä¸‹è¼‰æ ¼å¼\n  if ($json.photoUrl.includes('/uc?')) {\n    console.log(\"âŒ å¯èƒ½æ˜¯éœ€è¦æˆæ¬Šçš„ä¸‹è¼‰é€£çµ\");\n    console.log(\"å»ºè­°ä½¿ç”¨ thumbnailLink æ ¼å¼\");\n  }\n}\n\n// è¿”å›çµ¦ Ollama Vision\nreturn $json;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2336,
        -464
      ],
      "id": "e00a65a8-a5e9-4a91-a059-290e677b71c3",
      "name": "Code in JavaScript1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 3
          },
          "conditions": [
            {
              "id": "9c6125f8-3acd-4e87-ae45-7a3e0831dcfe",
              "leftValue": "={{ $json.meme_score }}",
              "rightValue": 1,
              "operator": {
                "type": "number",
                "operation": "gt"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.3,
      "position": [
        3856,
        -464
      ],
      "id": "5e41ca10-3c4c-4176-821c-2b38e1dd3bd4",
      "name": "If"
    },
    {
      "parameters": {
        "jsCode": "// === ç¬¬ 17 ç¯€é»ï¼šSelect Best Caption (å®Œç¾å°æ¥ç‰ˆ) ===\nconst item = $input.first();\n\n// 1. ç²å– Ollama çš„æ’åå›è¦† (ä¾‹å¦‚ \"1\")\nconst rankingResponse = item.json.response || \"\";\n\n// 2. ç²å–æ¨™é¡Œé™£åˆ— - ä½¿ç”¨æœ€ç²¾æº–çš„ç¯€é»å¼•ç”¨æ–¹å¼\nlet captions = [];\ntry {\n  // æ³¨æ„ï¼šé€™è£¡çš„åå­—å¿…é ˆèˆ‡ä½ ç•«é¢ä¸Šç¬¬ 15 ç¯€é»é¡¯ç¤ºçš„åç¨±ä¸€æ¨¡ä¸€æ¨£\n  // å¦‚æœä½ çš„ç¯€é»åç¨±çœŸçš„æ˜¯ \"Parse Captions\"ï¼Œä¸‹é¢é€™è¡Œå°±æ²’å•é¡Œ\n  const sourceNode = $(\"Parse Captions\"); \n  captions = sourceNode.item.json.captions || [];\n  console.log('æˆåŠŸå¾ Parse Captions ç²å–æ¨™é¡Œæ•¸é‡:', captions.length);\n} catch (e) {\n  console.error(\"ç„¡æ³•æ‰¾åˆ° Parse Captions ç¯€é»ï¼Œå˜—è©¦å¾ç•¶å‰è¼¸å…¥å°‹æ‰¾å‚™ä»½...\");\n  captions = item.json.captions || [];\n}\n\ntry {\n  // ä½¿ç”¨æ­£å‰‡è¡¨é”å¼æå–æ•¸å­— 0-4\n  const numberMatch = rankingResponse.match(/[0-4]/);\n  let bestIndex = 0;\n  \n  if (numberMatch) {\n    bestIndex = parseInt(numberMatch[0]);\n  }\n\n  // 3. å®‰å…¨æª¢æŸ¥ï¼šå¦‚æœæ²’æŠ“åˆ°æ¨™é¡Œï¼Œçµ¦å‡ºç·Šæ€¥ä¿åº•ï¼Œé¿å…æµç¨‹å´©æ½°\n  if (!captions || captions.length === 0) {\n    console.warn(\"è­¦å‘Š: æ¨™é¡Œåˆ—è¡¨ç‚ºç©ºï¼Œä½¿ç”¨ç·Šæ€¥ä¿åº•æ–‡å­—\");\n    captions = [\"Meme Data Error\", \"Check Parse Node\", \"Caption Not Found\"];\n  }\n\n  // ç¢ºä¿ç´¢å¼•ä¸è¶…å‡ºé™£åˆ—ç¯„åœ\n  if (bestIndex < 0 || bestIndex >= captions.length) {\n    bestIndex = 0;\n  }\n  \n  const bestCaption = captions[bestIndex];\n  \n  // 4. è¿”å›æœ€çµ‚çµæœï¼Œä¸¦ç¢ºä¿å‚³é Binary (åœ–ç‰‡)\n  return {\n    json: {\n      ...item.json,\n      best_index: bestIndex,\n      best_caption: bestCaption, // é€™è£¡æœƒæ˜¯çœŸæ­£çš„æ¨™é¡Œå…§å®¹\n      status: (bestCaption === \"Meme Data Error\") ? \"warning\" : \"success\"\n    },\n    // ã€æ¥µé‡è¦ã€‘å°‡åœ–ç‰‡æ•¸æ“šå‚³çµ¦å¾Œé¢çš„ PIL ç¯€é»\n    binary: item.binary \n  };\n  \n} catch (error) {\n  console.error('Select Best Caption åŸ·è¡ŒéŒ¯èª¤:', error);\n  return {\n    json: { \n      ...item.json, \n      best_caption: \"Final Error Fallback\", \n      error: error.message \n    },\n    binary: item.binary\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4752,
        -464
      ],
      "id": "00cf881d-41a3-4896-9910-21cfdfaa409b",
      "name": "Select Best Caption"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.18.0.2:11434/api/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"mistral:7b\",\n  \"prompt\": {{ \n    JSON.stringify(\n      \"You are a meme expert. Below are 5 candidate captions. Rank them and output ONLY the index number (0, 1, 2, 3, or 4) of the best one.\\n\\n\" + \n      $json.captions.map((c, i) => i + \": \" + c).join(\"\\n\") + \n      \"\\n\\nBest index:\"\n    ) \n  }},\n  \"stream\": false,\n  \"options\": {\n    \"temperature\": 0.3,\n    \"num_predict\": 10\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4528,
        -464
      ],
      "id": "c936630c-7dbe-4b6c-94fa-bf5007b16f33",
      "name": "Rank Best Caption"
    },
    {
      "parameters": {
        "jsCode": "// è§£ææ¨™é¡Œç”Ÿæˆçµæœ\nconst item = $input.first();\n\nif (!item || !item.json) {\n  return {\n    json: {\n      ...$json,\n      caption_error: 'No response from caption generation',\n      captions: [\"Caption generation failed\"],\n      captions_count: 0\n    }\n  };\n}\n\nconst response = item.json.response || item.json;\nconsole.log('æ¨™é¡Œç”ŸæˆåŸå§‹éŸ¿æ‡‰:', response.substring(0, 150) + '...');\n\ntry {\n  // æ–¹æ³•1ï¼šå˜—è©¦æå–JSONæ•¸çµ„\n  const jsonMatch = response.match(/\\[[\\s\\S]*\\]/);\n  \n  if (jsonMatch) {\n    const captions = JSON.parse(jsonMatch[0]);\n    \n    if (Array.isArray(captions) && captions.length > 0) {\n      return {\n        json: {\n          ...$json,\n          captions_raw: response,\n          captions: captions,\n          captions_count: captions.length,\n          caption_success: true\n        }\n      };\n    }\n  }\n  \n  // æ–¹æ³•2ï¼šå¦‚æœä¸æ˜¯JSONï¼Œå˜—è©¦æŒ‰è¡Œåˆ†å‰²\n  const lines = response.split('\\n')\n    .map(line => line.trim())\n    .filter(line => \n      line.length > 0 && \n      !line.startsWith('[') && \n      !line.startsWith('{') &&\n      !line.includes('```') &&\n      line.length < 100\n    );\n  \n  // å–å‰5è¡Œä½œç‚ºæ¨™é¡Œ\n  const captions = lines.slice(0, 5);\n  \n  if (captions.length > 0) {\n    return {\n      json: {\n        ...$json,\n        captions_raw: response,\n        captions: captions,\n        captions_count: captions.length,\n        caption_success: true,\n        note: 'Extracted from text lines'\n      }\n    };\n  }\n  \n  // æ–¹æ³•3ï¼šæœ€å¾Œçš„å‚™é¸æ–¹æ¡ˆ\n  const defaultCaptions = [\n    \"When you realize it's Monday tomorrow\",\n    \"My brain during meetings\",\n    \"Trying to adult but failing\",\n    \"That moment when...\",\n    \"My energy levels right now\"\n  ];\n  \n  return {\n    json: {\n      ...$json,\n      captions_raw: response,\n      captions: defaultCaptions,\n      captions_count: defaultCaptions.length,\n      caption_success: false,\n      note: 'Using default captions'\n    }\n  };\n  \n} catch (error) {\n  console.error('è§£ææ¨™é¡Œå¤±æ•—:', error);\n  \n  return {\n    json: {\n      ...$json,\n      caption_error: error.message,\n      captions: [\"Error: \" + error.message.substring(0, 30)],\n      captions_count: 1,\n      caption_success: false\n    }\n  };\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4304,
        -464
      ],
      "id": "54562723-0d5d-4b85-b275-204c678ac629",
      "name": "Parse Captions"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.18.0.2:11434/api/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"mistral:7b\",\n  \"prompt\": \"Generate 5 short, funny, relatable meme captions in Gen-Z style for this photo description: {{ $json.meme_description.replace(/\"/g, '\\\\\"') }}\\n\\nMake them sarcastic, self-deprecating, or highly relatable. Number them 1 to 5. Keep each caption short (under 15 words). Only output the numbered list, no extra text.\",\n  \"stream\": false,\n  \"options\": {\n    \"temperature\": 0.9,\n    \"num_predict\": 300\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        4080,
        -464
      ],
      "id": "00bb1cd5-b130-4a6c-8a2d-621e2743de73",
      "name": "Generate Meme Captions"
    },
    {
      "parameters": {
        "language": "python",
        "pythonCode": "from PIL import Image, ImageDraw, ImageFont\nfrom io import BytesIO\nimport base64\n\nitems = _input.all()\noutput_items = []\n\nfor item in items:\n    json_data = dict(item.json)\n    caption = json_data.get('best_caption', 'NO CAPTION').upper()\n\n    image_bytes = None\n\n    # å¾ Set Fields å‚³è½åšŸå˜… base64 å–åŸåœ–\n    try:\n        b64_string = json_data.get('original_image_base64')\n        if b64_string:\n            if ',' in b64_string:  # æ¸…é™¤å¯èƒ½æœ‰å˜… header\n                b64_string = b64_string.split(',')[1]\n            image_bytes = base64.b64decode(b64_string)\n            print(f\"âœ… æˆåŠŸå¾ json.original_image_base64 å–åœ–ï¼Œé•·åº¦={len(image_bytes)} bytes\")\n    except Exception as e:\n        print(f\"âŒ base64 è§£ç¢¼å¤±æ•—: {str(e)}\")\n\n    try:\n        if image_bytes and len(image_bytes) > 5000:\n            # è¼‰å…¥åŸåœ–ä¸¦è½‰ RGB\n            img = Image.open(BytesIO(image_bytes)).convert('RGB')\n            print(f\"åŸå§‹åœ–ç‰‡è¼‰å…¥æˆåŠŸï¼Œå¤§å°: {img.size}\")\n\n            # === é—œéµï¼šå…ˆè£å‰ªæˆæ­£æ–¹å½¢ï¼ˆä¸­å¿ƒ cropï¼‰ï¼Œé¿å…è®Šå½¢ ===\n            width, height = img.size\n            size = min(width, height)\n            left = (width - size) // 2\n            top = (height - size) // 2\n            img = img.crop((left, top, left + size, top + size))\n\n            # === å† resize åˆ° IG æœ€ä½³ 1080x1080 ===\n            img = img.resize((1080, 1080), Image.Resampling.LANCZOS)\n\n            # åŠ æ–‡å­—\n            draw = ImageDraw.Draw(img)\n\n            # å­—é«”ï¼ˆç›¡é‡å¤§ï¼‰\n            try:\n                font = ImageFont.truetype(\"arial.ttf\", 100)\n            except:\n                try:\n                    font = ImageFont.truetype(\"DejaVuSans-Bold.ttf\", 100)\n                except:\n                    font = ImageFont.load_default()\n                    print(\"âš ï¸ ä½¿ç”¨é è¨­å­—é«”\")\n\n            # åº•éƒ¨ç½®ä¸­\n            bbox = draw.textbbox((0, 0), caption, font=font)\n            text_width = bbox[2] - bbox[0]\n            text_height = bbox[3] - bbox[1]\n            position = ((1080 - text_width) // 2, 1080 - text_height - 60)\n\n            # ç¶“å…¸é»‘é‚Šç™½å­—\n            stroke = 8\n            for x in range(-stroke, stroke + 1):\n                for y in range(-stroke, stroke + 1):\n                    if x != 0 or y != 0:\n                        draw.text((position[0] + x, position[1] + y), caption, font=font, fill=\"black\")\n            draw.text(position, caption, font=font, fill=\"white\")\n\n            # === IG æœ€ä½³ JPEG ä¿å­˜åƒæ•¸ ===\n            out = BytesIO()\n            img.save(\n                out,\n                format=\"JPEG\",\n                quality=95,\n                optimize=True,\n                progressive=True,\n                subsampling=0\n            )\n            final_bytes = out.getvalue()\n            print(f\"âœ… meme ç”Ÿæˆå®Œæˆï¼æœ€çµ‚å°ºå¯¸: 1080x1080, æª”æ¡ˆå¤§å°: {len(final_bytes)/1024:.1f} KB\")\n\n        else:\n            # ä¿åº•ç´…åœ–\n            img = Image.new('RGB', (1080, 1080), color=\"#FF0000\")\n            final_bytes = BytesIO()\n            img.save(final_bytes, format=\"JPEG\")\n            final_bytes = final_bytes.getvalue()\n            print(\"âŒ å–ä¸åˆ°åŸåœ–ï¼Œä½¿ç”¨ç´…è‰²ä¿åº•\")\n\n        output_items.append({\n            \"json\": {\n                **json_data,\n                \"debug_info\": \"meme ç”ŸæˆæˆåŠŸ (1080x1080 IG å„ªåŒ–)\"\n            },\n            \"binary\": {\n                \"data\": {\n                    \"data\": final_bytes,\n                    \"mimeType\": \"image/jpeg\",\n                    \"fileName\": \"meme.jpg\",\n                    \"fileExtension\": \"jpg\"\n                }\n            }\n        })\n\n    except Exception as e:\n        print(f\"âŒ PIL éŒ¯èª¤: {str(e)}\")\n        output_items.append({\"json\": {**json_data, \"error\": str(e)}})\n\nreturn output_items"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5200,
        -464
      ],
      "id": "4ae99445-cf24-43ed-a59b-71c85e2cf27c",
      "name": "Create Meme with PIL"
    },
    {
      "parameters": {
        "url": "=https://graph.facebook.com/v18.0/{{ $node[\"Instagram - Publish Media\"].json[\"id\"] }}",
        "sendQuery": true,
        "specifyQuery": "json",
        "jsonQuery": "={\n  \"fields\": \"id,permalink,like_count,comments_count,timestamp,media_type,media_url,caption\",\n  \"access_token\": \"EAAMZAUnlAq3wBQfiglZAjClQ4ZAuSNdRoHEZC3dk8Bh4JA4xzSZCy3WKqniPoTkHaieRkwonZCQsBNcgZCSyrqZAZCkPcGnbrGx0TfslpoBKePbJGv1VBiEr8BduMunj9Db4JySaooj41jCFG6heZAFxm2DtpIaEScitKegy9fmCzvCJLMZCQ0WMtZCmZBUaIm4jgu3WYaahcpgZDZD\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6400,
        -464
      ],
      "id": "c3ba845b-077d-4e1d-bdd1-2f913839cf0d",
      "name": "Instagram - Check Status"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v20.0/17841467811092478/media_publish",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"creation_id\": \"{{ $node[\"Instagram - Create Media\"].json.id }}\",\n  \"access_token\": \"EAAMZAUnlAq3wBQfiglZAjClQ4ZAuSNdRoHEZC3dk8Bh4JA4xzSZCy3WKqniPoTkHaieRkwonZCQsBNcgZCSyrqZAZCkPcGnbrGx0TfslpoBKePbJGv1VBiEr8BduMunj9Db4JySaooj41jCFG6heZAFxm2DtpIaEScitKegy9fmCzvCJLMZCQ0WMtZCmZBUaIm4jgu3WYaahcpgZDZD\"\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        6176,
        -464
      ],
      "id": "b9c410af-c296-4040-9fc6-0e4f9f41321c",
      "name": "Instagram - Publish Media"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://graph.facebook.com/v20.0/17841467811092478/media",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "=json",
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "jsonBody": "={\n  \"image_url\": \"{{ $node[\"Upload to ImgBB\"].json.data.display_url }}\",\n  \"caption\": \"{{ $json.caption || $json.selected_caption || 'AI generated meme' }}\\n\\n#AIç”Ÿæˆ #æç¬‘ #Meme\",\n  \"access_token\": \"EAAMZAUnlAq3wBQfiglZAjClQ4ZAuSNdRoHEZC3dk8Bh4JA4xzSZCy3WKqniPoTkHaieRkwonZCQsBNcgZCSyrqZAZCkPcGnbrGx0TfslpoBKePbJGv1VBiEr8BduMunj9Db4JySaooj41jCFG6heZAFxm2DtpIaEScitKegy9fmCzvCJLMZCQ0WMtZCmZBUaIm4jgu3WYaahcpgZDZD\"\n}",
        "options": {
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5920,
        -464
      ],
      "id": "2c57d4c6-397c-4686-b943-c8cfc10b67ab",
      "name": "Instagram - Create Media",
      "credentials": {
        "oAuth2Api": {
          "id": "cwajW1cqHSXiCFMH",
          "name": "Unnamed credential 2"
        }
      }
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "1qLwJ9LFge2-POHZ_BpmsNiuDrOAiR4-X87OXeJm1x1g",
          "mode": "list",
          "cachedResultName": "Meme Factory Logs",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qLwJ9LFge2-POHZ_BpmsNiuDrOAiR4-X87OXeJm1x1g/edit?usp=drivesdk"
        },
        "sheetName": {
          "__rl": true,
          "value": "gid=0",
          "mode": "list",
          "cachedResultName": "å·¥ä½œè¡¨1",
          "cachedResultUrl": "https://docs.google.com/spreadsheets/d/1qLwJ9LFge2-POHZ_BpmsNiuDrOAiR4-X87OXeJm1x1g/edit#gid=0"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "timestamp": "{{ new Date().toISOString() }}",
            "post_id": "{{ $json.meme_id }}",
            "caption": "{{ $json.meme_caption }}",
            "image_url": "{{ $json.original_image || $json.url }}",
            "meme_score": "{{ $json.meme_score }}",
            "engagement_metrics": "{{\\\"likes\\\":0,\\\"comments\\\":0,\\\"shares\\\":0}}",
            "platform": "instagram",
            "status": "created"
          },
          "matchingColumns": [],
          "schema": [
            {
              "id": "timestamp",
              "displayName": "timestamp",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "post_id",
              "displayName": "post_id",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "caption",
              "displayName": "caption",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "image_url",
              "displayName": "image_url",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "meme_score",
              "displayName": "meme_score",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "engagement_metrics",
              "displayName": "engagement_metrics",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "platform",
              "displayName": "platform",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            },
            {
              "id": "status",
              "displayName": "status",
              "required": false,
              "defaultMatch": false,
              "display": true,
              "type": "string",
              "canBeUsedToMatch": true,
              "removed": false
            }
          ],
          "attemptToConvertTypes": false,
          "convertFieldsToString": false
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [
        6624,
        -464
      ],
      "id": "ae559811-958a-4f19-88dc-14b734bfb740",
      "name": "Append row in sheet",
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "g1wYOCKsqLrvF2fv",
          "name": "Google Sheets account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// æ–°å¢ç¯€é»æˆ–ä¿®æ”¹ç¾æœ‰ç¯€é»\nconst sevenDaysAgo = new Date();\nsevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\n\n// æ ¼å¼åŒ–ç‚º Google Drive API éœ€è¦çš„æ ¼å¼\nconst fromDate = sevenDaysAgo.toISOString().split('T')[0] + 'T00:00:00';\n\n// è¿”å›åƒæ•¸çµ¦ä¸‹ä¸€å€‹ HTTP Request ç¯€é»\nreturn [{\n  json: {\n    // ğŸ”´ é‡è¦ï¼šæ›¿æ›ç‚ºä½ çš„ Google ç›¸ç°¿è³‡æ–™å¤¾ ID\n    folder_id: \"1n9C68MRqHTYSjUpgtuTNzjFSgqyJ9LGs\",\n    \n    // 7å¤©å‰çš„æ—¥æœŸ\n    from_date: fromDate,  // æ ¼å¼: 2024-12-14T00:00:00\n    \n    // å…¶ä»–æŸ¥è©¢åƒæ•¸\n    mime_types: \"image/jpeg,image/png,image/gif,image/heic\",\n    page_size: \"100\"\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        368,
        -320
      ],
      "id": "571045fe-9099-41b6-8937-ac4bd665f79e",
      "name": "Code in JavaScript2"
    },
    {
      "parameters": {
        "options": {
          "reset": false
        }
      },
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [
        2112,
        -320
      ],
      "id": "8fa7f6f8-1725-41b7-9e1f-119e59ff6b1f",
      "name": "Loop Over Items (Split In Batches)"
    },
    {
      "parameters": {
        "url": "https://www.googleapis.com/drive/v3/files",
        "authentication": "genericCredentialType",
        "genericAuthType": "oAuth2Api",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json; charset=utf-8"
            },
            {
              "name": "q",
              "value": "=mimeType contains 'image/' and '{{ $json.folder_id }}' in parents and modifiedTime > '{{ $json.from_date }}'"
            },
            {
              "name": "fields",
              "value": "=files(id, name, mimeType, webContentLink, thumbnailLink, modifiedTime, size, parents)"
            },
            {
              "name": "orderBy",
              "value": "modifiedTime desc"
            },
            {
              "name": "pageSize",
              "value": "100"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        592,
        -320
      ],
      "id": "85d0a5db-7962-4712-95ef-80c8557ee824",
      "name": "Google drive",
      "credentials": {
        "oAuth2Api": {
          "id": "cwajW1cqHSXiCFMH",
          "name": "Unnamed credential 2"
        },
        "googleOAuth2Api": {
          "id": "R4cPv7Hi8BxkGQgw",
          "name": "Google account 2"
        }
      }
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.18.0.2:11434/api/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"model\": \"llava:7b\",\n  \"prompt\": \"Analyze this image for meme potential. Be brief. Respond with format: 'Score: X/10 - Desc: [çŸ­æè¿°]'\",\n  \"images\": [\n    \"{{ $json.pureBase64ForOllama }}\"\n  ],\n  \"stream\": false,\n  \"options\": {\n    \"temperature\": 0.7\n  }\n}",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        3408,
        -464
      ],
      "id": "bac79a00-cab8-4562-9039-f45e47cee589",
      "name": "HTTP Request2 (Ollama Vision)"
    },
    {
      "parameters": {
        "jsCode": "// === ç¬¬ 12 ç¯€é»ï¼šå…¨è‡ªå‹• Binary æå–å™¨ ===\nconst items = $input.all();\n\nreturn items.map(item => {\n    let base64String = \"\";\n    let source = \"none\";\n\n    // 1. å¼·åˆ¶å¾ Binary æ•¸æ“šå±¤æå– (n8n å˜…åœ–ç‰‡çœŸæ­£å­˜æ”¾åœ°)\n    if (item.binary) {\n        // è‡ªå‹•æµç¬¬ä¸€å€‹æœ‰æ•ˆå˜… binary field (ä¾‹å¦‚ 'data' æˆ– 'file')\n        const binaryKeys = Object.keys(item.binary);\n        if (binaryKeys.length > 0) {\n            const key = binaryKeys[0];\n            // n8n binary .data å·²ç¶“ä¿‚ Base64 æ ¼å¼\n            base64String = item.binary[key].data;\n            source = `binary_${key}`;\n        }\n    }\n\n    // 2. å¦‚æœ Binary å†‡ï¼Œå…ˆè‡³å» JSON æµ (æœ€å¾Œé˜²ç·š)\n    if (!base64String && item.json.base64Image) {\n        base64String = item.json.base64Image.replace(/^data:image\\/\\w+;base64,/, \"\");\n        source = \"json_field\";\n    }\n\n    // 3. æª¢æŸ¥é•·åº¦ï¼Œå¦‚æœå¤ªçŸ­ (ä¾‹å¦‚å¾—å¹¾åå€‹å­—)ï¼Œä»£è¡¨å¼µåœ–å£å’—\n    if (!base64String || base64String.length < 500) {\n        return {\n            json: {\n                ...item.json,\n                pureBase64ForOllama: null,\n                ready: false,\n                error: \"ğŸš¨ æµå””åˆ°åœ–ç‰‡å…§å®¹ï¼è«‹ç¢ºä¿å‰é¢ä¿‚ Google Drive 'Download' ç¯€é»è€Œé 'List'\"\n            }\n        };\n    }\n\n    // 4. è¿”å›ä¹¾æ·¨å˜…æ•¸æ“šç•€ Ollama\n    return {\n        json: {\n            ...item.json,\n            pureBase64ForOllama: base64String, // å‘¢å€‹åè¦åŒç¬¬ 14 ç¯€é»å°æ‡‰\n            base64_length: base64String.length,\n            base64_source: source,\n            ready: true\n        },\n        binary: item.binary // å‚³åŸ‹ Binary è½å»ç•€å¾Œé¢å˜… PIL ç”¨\n    };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2768,
        -464
      ],
      "id": "b06084e2-f696-405c-b7bd-723a9d99e3a5",
      "name": "Fix Base64 for Ollama"
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\n\nreturn items.map(item => {\n  const text = item.json.text || item.json.response || \"\";  // Ollama å›å‚³å­—æ®µå¯èƒ½ä¿‚ text æˆ– response\n\n  // ç”¨æ­£å‰‡è¡¨é”å¼æå–åˆ†æ•¸ (Score: X/10)\n  const scoreMatch = text.match(/Score:\\s*(\\d+(\\.\\d+)?)\\/10/i);\n  let memeScore = 0;\n\n  if (scoreMatch && scoreMatch[1]) {\n    memeScore = parseFloat(scoreMatch[1]);\n    console.log(`âœ… æˆåŠŸæå– meme_score: ${memeScore}`);\n  } else {\n    console.log(`âš ï¸ ç„¡æ³•æå–åˆ†æ•¸ï¼Œå¾æ–‡å­—: \"${text}\"ï¼Œé è¨­çµ¦ 5`);\n    memeScore = 5;  // é è¨­ä¸­åˆ†ï¼Œé¿å…å…¨ä¸Ÿæ‰\n  }\n\n  // æå–æè¿°ï¼ˆå¯é¸ï¼‰\n  const descMatch = text.match(/Desc:\\s*(.+)/i);\n  const description = descMatch ? descMatch[1].trim() : \"No description\";\n\n  return {\n    json: {\n      ...item.json,\n      meme_score: memeScore,        // IF node ç”¨å‘¢å€‹æ•¸å­—\n      meme_description: description,\n      ollama_raw_response: text     // æ–¹ä¾¿ debug\n    },\n    binary: item.binary\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3632,
        -464
      ],
      "id": "fb4a8f34-d44f-4bb5-91f6-46f6de32e18f",
      "name": "Parse Meme Score"
    },
    {
      "parameters": {
        "jsCode": "// === ä¸­é–“ Debug ç¯€é» (æ¥åŠ›ç‰ˆ) ===\nconst item = $input.first();\n\n// åœ¨æ§åˆ¶å°è¼¸å‡ºèª¿è©¦è³‡è¨Š\nconsole.log('--- æ•¸æ“šå‚³è¼¸ç›£æ§ ---');\nconsole.log('Binary æ¬„ä½:', Object.keys(item.binary || {}));\nconsole.log('æ˜¯å¦å«æœ‰åœ–ç‰‡æ•¸æ“š:', !!item.binary);\n\n// ç¢ºä¿è¿”å›å®Œæ•´å°è±¡\nreturn {\n    json: item.json,\n    binary: item.binary // å¿…é ˆé¡¯å¼å‚³éï¼Œå¦å‰‡ä¸‹ä¸€ç«™ PIL æœƒè®Šç©º\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4976,
        -464
      ],
      "id": "7e03bcef-04d7-42d3-97fe-3c2d62b885fe",
      "name": "Code in JavaScript3"
    },
    {
      "parameters": {
        "name": "=meme_{{ $now.format('YYYYMMDD_HHmmss') }}.jpg",
        "driveId": {
          "__rl": true,
          "mode": "list",
          "value": "My Drive"
        },
        "folderId": {
          "__rl": true,
          "value": "={{ \"15J2te2-sdrQVz7lp9Liw539O9OP9FRfG\" }}",
          "mode": "id"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        144,
        848
      ],
      "id": "d3190995-d9bf-40e9-89c9-41bba1eb8f28",
      "name": "Upload file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "rh0Oz5y2uOjF5nUr",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "operation": "share",
        "fileId": {
          "__rl": true,
          "value": "={{ $json.id }}",
          "mode": "id"
        },
        "permissionsUi": {
          "permissionsValues": {
            "role": "reader",
            "type": "anyone"
          }
        },
        "options": {}
      },
      "type": "n8n-nodes-base.googleDrive",
      "typeVersion": 3,
      "position": [
        -128,
        208
      ],
      "id": "93f48631-8bee-48b9-94f0-eb15ca80596f",
      "name": "Share file",
      "credentials": {
        "googleDriveOAuth2Api": {
          "id": "rh0Oz5y2uOjF5nUr",
          "name": "Google Drive account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// === ç¬¬ 19 ç¯€é»ï¼šBase64 to Binary (å°æ¥ä¿®å¾©ç‰ˆ) ===\nconst items = $input.all();\n\nreturn items.map(item => {\n  // 1. ä¿®æ­£æ¬„ä½åç¨±ï¼šå°æ‡‰ Python ç¯€é»è¼¸å‡ºçš„ base64Image æˆ– pureBase64ForOllama\n  // æ ¹æ“šæˆ‘å€‘ä¹‹å‰çš„é‚è¼¯ï¼Œå„ªå…ˆæ‰¾ base64Imageï¼Œä¸¦å»æ‰ Data URI å‰ç¶´\n  let base64String = item.json.base64Image || item.json.meme_base64 || \"\";\n\n  // å¦‚æœåŒ…å« \"data:image/jpeg;base64,\" å‰ç¶´ï¼Œéœ€è¦å»æ‰æ‰èƒ½æ­£ç¢ºè½‰æ›\n  if (base64String.includes(',')) {\n    base64String = base64String.split(',')[1];\n  }\n\n  let binaryData;\n  let sourceStatus = \"success\";\n\n  if (!base64String || base64String.trim() === \"\") {\n    console.log(\"Warning: No valid Base64 found, using fallback\");\n    // ä½¿ç”¨ 1x1 ç°è‰²åƒç´ ä½œç‚ºä¿åº•ï¼Œé¿å…ç¯€é»å ±éŒ¯ä¸­æ–·\n    base64String = \"iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAQAAAC1HAwCAAAAC0lEQVR42mN8/R8AAnUBfALm6mMAAAAASUVORK5CYII=\";\n    sourceStatus = \"fallback\";\n  }\n\n  try {\n    binaryData = Buffer.from(base64String, 'base64');\n  } catch (e) {\n    console.error(\"Base64 è½‰æ›å¤±æ•—:\", e);\n    sourceStatus = \"error\";\n    binaryData = Buffer.from(\"\"); \n  }\n\n  return {\n    json: {\n      ...item.json,\n      binary_conversion: sourceStatus,\n      // å¢åŠ é€™å€‹æ¬„ä½æ–¹ä¾¿ ImgBB ä½¿ç”¨\n      has_binary: binaryData.length > 100\n    },\n    binary: {\n      data: {\n        data: binaryData,\n        mimeType: 'image/jpeg',\n        fileName: `meme_${Date.now()}.jpg`\n      }\n    }\n  };\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        160,
        192
      ],
      "id": "bb0d17e2-1507-4651-a792-8b2c3f674976",
      "name": "Base64 to Binary"
    },
    {
      "parameters": {
        "jsCode": "// ä¿®æ­£ç‰ˆï¼šä½¿ç”¨ this.helpers.httpRequest\nconst memeBase64 = items[0].json.meme_base64;\n\n// ä½ çš„ ImgBB API Keyï¼ˆæ›¿æ›é€™å€‹ï¼ï¼‰\nconst imgbbApiKey = 'f25c082385039db8f8f3be0f0fdb0d38';\n\ntry {\n  // ä½¿ç”¨æ­£ç¢ºçš„èªæ³•\n  const response = await this.helpers.httpRequest({\n    method: 'POST',\n    url: 'https://api.imgbb.com/1/upload',\n    headers: {\n      'Content-Type': 'application/json'\n    },\n    body: {\n      key: imgbbApiKey,\n      image: memeBase64\n    },\n    json: true  // è‡ªå‹•è§£æ JSON éŸ¿æ‡‰\n  });\n  \n  // æª¢æŸ¥æ˜¯å¦æˆåŠŸ\n  if (response.success) {\n    console.log('âœ… ImgBB ä¸Šå‚³æˆåŠŸï¼');\n    console.log('åœ–ç‰‡URL:', response.data.url);\n    \n    return [{\n      json: {\n        // Instagram éœ€è¦çš„å…¬é–‹åœ–ç‰‡ URL\n        instagram_image_url: response.data.url,\n        \n        // ä¿ç•™æ¨™é¡Œå’Œæ¨™ç±¤\n        caption: items[0].json.selected_caption || items[0].json.caption || \"AIç”Ÿæˆmeme\",\n        \n        // åŠ ä¸€äº›æ¨™ç±¤\n        hashtags: \"#AIç”Ÿæˆ #æç¬‘ #Meme #è‡ªå‹•ç”Ÿæˆ\",\n        \n        // åŸå§‹æ•¸æ“šï¼ˆå¯é¸ï¼‰\n        original_filename: items[0].json.filename,\n        meme_score: items[0].json.meme_score,\n        \n        // æ™‚é–“æˆ³\n        uploaded_at: new Date().toISOString()\n      }\n    }];\n  } else {\n    console.error('âŒ ImgBB ä¸Šå‚³å¤±æ•—:', response);\n    throw new Error('åœ–ç‰‡ä¸Šå‚³åˆ° ImgBB å¤±æ•—');\n  }\n} catch (error) {\n  console.error('âŒ ä¸Šå‚³éç¨‹å‡ºéŒ¯:', error.message);\n  \n  // è¿”å›éŒ¯èª¤ä¿¡æ¯ï¼Œä¸è¦è®“æ•´å€‹æµç¨‹å´©æ½°\n  return [{\n    json: {\n      error: error.message,\n      instagram_image_url: null,\n      caption: items[0].json.selected_caption || \"åœ–ç‰‡ä¸Šå‚³å¤±æ•—\",\n      uploaded_at: new Date().toISOString()\n    }\n  }];\n}"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        144,
        400
      ],
      "id": "acb51447-6e69-4271-a2ae-cb31067fbac7",
      "name": "ImgBB"
    },
    {
      "parameters": {
        "jsCode": "// Code ç¯€é»ï¼šèª¿è©¦ Instagram å‰çš„æ•¸æ“š\nconsole.log('=== Instagram ç¯€é»å‰æ•¸æ“šæª¢æŸ¥ ===');\n\n// 1. é¡¯ç¤ºæ‰€æœ‰æ•¸æ“š\nconsole.log('å®Œæ•´æ•¸æ“š:', JSON.stringify(items[0].json, null, 2));\n\n// 2. ç‰¹åˆ¥æª¢æŸ¥åœ–ç‰‡URL\nconst imageUrl = items[0].json.instagram_image_url;\nconsole.log('instagram_image_url å€¼:', imageUrl);\nconsole.log('é¡å‹:', typeof imageUrl);\nconsole.log('é•·åº¦:', imageUrl ? imageUrl.length : 0);\n\n// 3. æª¢æŸ¥æ˜¯å¦æœ‰å…¶ä»–å¯èƒ½çš„åœ–ç‰‡URLå­—æ®µ\nconsole.log('æ‰€æœ‰åŒ…å« \"image\" æˆ– \"url\" çš„å­—æ®µ:');\nObject.keys(items[0].json).forEach(key => {\n  if (key.toLowerCase().includes('image') || key.toLowerCase().includes('url')) {\n    console.log(`  ${key}:`, items[0].json[key]);\n  }\n});\n\n// 4. å¦‚æœæ²’æœ‰ instagram_image_urlï¼Œå˜—è©¦ç”¨å…¶ä»–å­—æ®µ\nlet finalImageUrl = imageUrl;\nif (!finalImageUrl || finalImageUrl === '' || finalImageUrl === 'null') {\n  console.log('âš ï¸ instagram_image_url ç„¡æ•ˆï¼Œå°‹æ‰¾æ›¿ä»£å­—æ®µ...');\n  \n  // å˜—è©¦å…¶ä»–å¯èƒ½çš„å­—æ®µåç¨±\n  const possibleFields = [\n    'image_url',\n    'meme_direct_url', \n    'url',\n    'direct_url',\n    'img_url',\n    'photo_url'\n  ];\n  \n  for (const field of possibleFields) {\n    if (items[0].json[field]) {\n      console.log(`âœ… æ‰¾åˆ°æ›¿ä»£å­—æ®µ: ${field} = ${items[0].json[field]}`);\n      finalImageUrl = items[0].json[field];\n      break;\n    }\n  }\n}\n\n// 5. ç¢ºä¿æœ€çµ‚æœ‰åœ–ç‰‡URL\nif (!finalImageUrl || finalImageUrl === '' || finalImageUrl === 'null') {\n  console.error('âŒ éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°æœ‰æ•ˆçš„åœ–ç‰‡URLï¼');\n  console.log('æ‰€æœ‰å¯ç”¨å­—æ®µ:', Object.keys(items[0].json));\n  \n  // å‰µå»ºä¸€å€‹æ¸¬è©¦URLï¼Œè®“æµç¨‹ç¹¼çºŒ\n  finalImageUrl = `https://picsum.photos/1080/1080?random=${Date.now()}`;\n  console.log(`âš ï¸ ä½¿ç”¨æ¸¬è©¦åœ–ç‰‡: ${finalImageUrl}`);\n}\n\n// 6. å‚³éä¿®æ­£å¾Œçš„æ•¸æ“š\nreturn [{\n  json: {\n    // ç¢ºä¿é€™å€‹å­—æ®µåç¨±å’Œ Instagram ç¯€é»åŒ¹é…\n    instagram_image_url: finalImageUrl,\n    \n    // å‚³éæ‰€æœ‰åŸå§‹æ•¸æ“š\n    ...items[0].json,\n    \n    // æ¨™è¨˜æ˜¯å¦ä¿®æ­£é\n    _debug_fixed_image_url: !imageUrl\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        144,
        624
      ],
      "id": "0cb5188f-bb21-49d1-ace8-4182dba5abe9",
      "name": "Code in JavaScript4"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.imgbb.com/1/upload",
        "sendQuery": true,
        "queryParameters": {
          "parameters": [
            {
              "name": "key",
              "value": "f25c082385039db8f8f3be0f0fdb0d38"
            }
          ]
        },
        "sendBody": true,
        "contentType": "multipart-form-data",
        "bodyParameters": {
          "parameters": [
            {
              "parameterType": "formBinaryData",
              "name": "image",
              "inputDataFieldName": "data"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        5680,
        -464
      ],
      "id": "568735ab-50e5-439d-8975-d1bd2ee45a75",
      "name": "Upload to ImgBB"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "http://172.18.0.2:11434/api/generate",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n     \"model\": \"mistral:7b\",\n     \"prompt\": \"Test connection\",\n     \"stream\": false\n   }",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        384,
        400
      ],
      "id": "783cd284-43a6-4fc9-aad2-09dca999a442",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "jsCode": "// æª¢æŸ¥PILç”Ÿæˆçš„åœ–ç‰‡æ•¸æ“š\nconst item = $input.all()[0];\n\nconsole.log('ğŸ–¼ï¸ æª¢æŸ¥PILç”Ÿæˆçµæœï¼š');\n\n// æª¢æŸ¥æ˜¯å¦æœ‰binaryæ•¸æ“š\nif (item.binary && item.binary.data) {\n  console.log('âœ… æœ‰binaryæ•¸æ“š');\n  console.log('- Binaryå¤§å°:', item.binary.data.data.length, 'bytes');\n  console.log('- Binaryé¡å‹:', item.binary.data.mimeType);\n  console.log('- æª”æ¡ˆåç¨±:', item.binary.data.fileName);\n} else {\n  console.log('âŒ æ²’æœ‰binaryæ•¸æ“šï¼');\n}\n\n// æª¢æŸ¥base64\nif (item.json && item.json.base64Image) {\n  const base64 = item.json.base64Image;\n  console.log('âœ… æœ‰base64æ•¸æ“š');\n  console.log('- Base64é•·åº¦:', base64.length);\n  console.log('- å‰100å­—ç¬¦:', base64.substring(0, 100));\n  \n  // æª¢æŸ¥base64æ ¼å¼\n  if (base64.includes('data:image/')) {\n    console.log('ğŸ“ Base64æœ‰data URIå‰ç¶´');\n    const mimeType = base64.split(';')[0].replace('data:', '');\n    console.log('- MIMEé¡å‹:', mimeType);\n  }\n  \n  // ç°¡å–®é©—è­‰base64\n  try {\n    const cleanBase64 = base64.includes('base64,') ? \n      base64.split('base64,')[1] : base64;\n    const buffer = Buffer.from(cleanBase64, 'base64');\n    console.log('- Base64è§£ç¢¼å¾Œå¤§å°:', buffer.length, 'bytes');\n    \n    // é¡å¤–ï¼šæª¢æŸ¥åœ–ç‰‡æ˜¯å¦æœ‰æ•ˆ\n    if (buffer.length < 100) {\n      console.log('âŒ è­¦å‘Šï¼šåœ–ç‰‡æ•¸æ“šå¤ªå°ï¼Œå¯èƒ½æå£');\n    }\n  } catch (e) {\n    console.log('âŒ Base64è§£ç¢¼å¤±æ•—:', e.message);\n  }\n} else {\n  console.log('âŒ æ²’æœ‰base64æ•¸æ“šï¼');\n}\n\n// å°‡æ‰€æœ‰æ•¸æ“šåŸæ¨£å‚³éï¼Œä¸ä¿®æ”¹\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        5456,
        -464
      ],
      "id": "0039707d-4da1-479f-849e-8ddd2ff2fc2c",
      "name": "debug"
    },
    {
      "parameters": {
        "jsCode": "// æª¢æŸ¥Google Driveä¸‹è¼‰çš„åœ–ç‰‡\nconst item = $input.all()[0];\n\nconsole.log('=== Google Driveä¸‹è¼‰æª¢æŸ¥ ===');\nconsole.log('ğŸ“¥ åŸå§‹è¼¸å…¥:', Object.keys(item));\n\n// æª¢æŸ¥æ˜¯å¦æœ‰binaryæ•¸æ“š\nif (item.binary) {\n  const binaryKeys = Object.keys(item.binary);\n  console.log(`âœ… æœ‰binaryæ•¸æ“š: ${binaryKeys.length}å€‹æ–‡ä»¶`);\n  \n  binaryKeys.forEach(key => {\n    const binaryData = item.binary[key];\n    console.log(`æ–‡ä»¶ \"${key}\":`);\n    console.log(`  - å¤§å°: ${binaryData.data?.length || 0} bytes`);\n    console.log(`  - MIMEé¡å‹: ${binaryData.mimeType || 'æœªçŸ¥'}`);\n    console.log(`  - æª”æ¡ˆå: ${binaryData.fileName || 'æœªçŸ¥'}`);\n    \n    // æª¢æŸ¥æ˜¯å¦ç‚ºåœ–ç‰‡\n    const isImage = binaryData.mimeType?.startsWith('image/');\n    console.log(`  - æ˜¯å¦åœ–ç‰‡: ${isImage ? 'âœ… æ˜¯' : 'âŒ å¦'}`);\n    \n    if (binaryData.data && binaryData.data.length > 0) {\n      // å˜—è©¦è½‰æ›ç‚ºbase64ä¸¦å–å‰100å­—ç¬¦æª¢æŸ¥\n      const base64 = Buffer.from(binaryData.data).toString('base64');\n      console.log(`  - Base64å‰100å­—ç¬¦: ${base64.substring(0, 100)}...`);\n    }\n  });\n} else {\n  console.log('âŒ æ²’æœ‰binaryæ•¸æ“šï¼Google Driveå¯èƒ½ä¸‹è¼‰å¤±æ•—');\n}\n\n// æ·»åŠ æ¨™è¨˜ä»¥ä¾¿è¿½è¹¤\nreturn {\n  json: {\n    ...item.json,\n    _debug_google_drive: {\n      has_binary: !!item.binary,\n      binary_count: item.binary ? Object.keys(item.binary).length : 0,\n      timestamp: new Date().toISOString()\n    }\n  },\n  binary: item.binary\n};"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        800,
        -320
      ],
      "id": "75857dfc-01b3-4346-ac68-577145fc3d24",
      "name": "debug1"
    },
    {
      "parameters": {
        "jsCode": "// æª¢æŸ¥ç¬¬ä¸€æ¬¡JSè™•ç†å¾Œçš„æ•¸æ“š\nconst item = $input.all()[0];\n\nconsole.log('=== ç¬¬ä¸€æ¬¡JSè™•ç†æª¢æŸ¥ ===');\nconsole.log('JSON keys:', Object.keys(item.json));\n\n// æª¢æŸ¥base64Imageæ˜¯å¦å­˜åœ¨\nif (item.json.base64Image) {\n  console.log('âœ… æœ‰base64Image');\n  const base64 = item.json.base64Image;\n  console.log(`- é•·åº¦: ${base64.length}`);\n  console.log(`- æ˜¯å¦æœ‰å‰ç¶´: ${base64.includes('data:image/') ? 'æ˜¯' : 'å¦'}`);\n  \n  // å˜—è©¦è§£ç¢¼æª¢æŸ¥\n  try {\n    const cleanBase64 = base64.includes('base64,') ? \n      base64.split('base64,')[1] : base64;\n    const buffer = Buffer.from(cleanBase64, 'base64');\n    console.log(`- è§£ç¢¼å¾Œå¤§å°: ${buffer.length} bytes`);\n    \n    if (buffer.length < 1000) {\n      console.log('âš ï¸ è­¦å‘Šï¼šåœ–ç‰‡æ•¸æ“šéå¸¸å°ï¼Œå¯èƒ½æå£');\n    }\n  } catch (e) {\n    console.log(`âŒ Base64è§£ç¢¼å¤±æ•—: ${e.message}`);\n  }\n} else {\n  console.log('âŒ æ²’æœ‰base64Imageï¼');\n}\n\n// æª¢æŸ¥pureBase64ForOllama\nif (item.json.pureBase64ForOllama) {\n  console.log('âœ… æœ‰pureBase64ForOllama');\n  console.log(`- é•·åº¦: ${item.json.pureBase64ForOllama.length}`);\n} else {\n  console.log('âŒ æ²’æœ‰pureBase64ForOllama');\n}\n\n// æª¢æŸ¥binaryæ˜¯å¦é‚„åœ¨\nif (item.binary) {\n  console.log('âœ… binaryæ•¸æ“šé‚„åœ¨');\n} else {\n  console.log('âš ï¸ binaryæ•¸æ“šå¯èƒ½å·²ä¸Ÿå¤±');\n}\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1232,
        -320
      ],
      "id": "71260921-625a-454b-b219-f4fe240d6235",
      "name": "debug2"
    },
    {
      "parameters": {
        "jsCode": "// æª¢æŸ¥ä¿®å¾©å¾Œçš„Ollama base64\nconst item = $input.all()[0];\n\nconsole.log('=== Ollama Base64ä¿®å¾©æª¢æŸ¥ ===');\nconsole.log('JSON keys:', Object.keys(item.json));\n\n// ç‰¹åˆ¥æª¢æŸ¥pureBase64ForOllama\nif (item.json.pureBase64ForOllama) {\n  const pureBase64 = item.json.pureBase64ForOllama;\n  console.log(`âœ… pureBase64ForOllama: ${pureBase64.length} å­—ç¬¦`);\n  \n  // è©³ç´°åˆ†æ\n  console.log('ğŸ”¬ Base64åˆ†æ:');\n  console.log(`- æ˜¯å¦ç´”Base64: ${!pureBase64.includes('data:image/') ? 'âœ… æ˜¯' : 'âŒ å¦'}`);\n  console.log(`- æ˜¯å¦å«ç©ºæ ¼/æ›è¡Œ: ${/\\s/.test(pureBase64) ? 'âŒ æ˜¯' : 'âœ… å¦'}`);\n  \n  // å˜—è©¦è§£ç¢¼\n  try {\n    const buffer = Buffer.from(pureBase64, 'base64');\n    console.log(`- è§£ç¢¼å¤§å°: ${buffer.length} bytes`);\n    console.log(`- å¤§ç´„åƒç´ æ•¸: ${Math.sqrt(buffer.length / 3)}x${Math.sqrt(buffer.length / 3)}`);\n    \n    if (buffer.length < 5000) {\n      console.log('âŒ åš´é‡ï¼šåœ–ç‰‡æ•¸æ“šå¤ªå°ï¼Œä¸è¶³ä»¥ç”Ÿæˆmeme');\n      console.log('å¯èƒ½åŸå› :');\n      console.log('1. åŸå§‹åœ–ç‰‡ä¸‹è¼‰å¤±æ•—');\n      console.log('2. Base64è½‰æ›æœ‰å•é¡Œ');\n      console.log('3. æ•¸æ“šåœ¨å‚³éä¸­ä¸Ÿå¤±');\n    } else {\n      console.log(`âœ… åœ–ç‰‡æ•¸æ“šè¶³å¤  (${Math.round(buffer.length/1024)} KB)`);\n    }\n  } catch (e) {\n    console.log(`âŒ Base64è§£ç¢¼éŒ¯èª¤: ${e.message}`);\n  }\n} else {\n  console.log('âŒâŒâŒ åš´é‡ï¼šæ²’æœ‰pureBase64ForOllamaï¼');\n}\n\n// æª¢æŸ¥åŸå§‹base64Image\nif (item.json.base64Image) {\n  console.log(`ğŸ“ base64Image: ${item.json.base64Image.length} å­—ç¬¦`);\n} else {\n  console.log('âŒ æ²’æœ‰base64Image');\n}\n\nreturn item;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2976,
        -464
      ],
      "id": "9c05a384-5da6-4571-ad87-ffd7da5970bc",
      "name": "debug3"
    },
    {
      "parameters": {
        "url": "={{ $json.downloadUrl }}",
        "options": {
          "redirect": {
            "redirect": {}
          },
          "response": {
            "response": {
              "fullResponse": true,
              "responseFormat": "file",
              "outputPropertyName": "binary"
            }
          },
          "timeout": 60000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        2544,
        -464
      ],
      "id": "383b8bb7-563b-41bc-8d2c-616d5fbea3b1",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "jsCode": "// å–å¾—æ‰€æœ‰è¼¸å…¥é …ç›®\nconst items = $input.all();\n\nfor (let i = 0; i < items.length; i++) {\n  try {\n    // 1. è‡ªå‹•å°‹æ‰¾ Binary æ¬„ä½åç¨± (é€šå¸¸æ˜¯ 'data')\n    const binaryKeys = Object.keys(items[i].binary || {});\n    \n    if (binaryKeys.length > 0) {\n      // 2. ä½¿ç”¨ n8n æ¨è–¦çš„æ–°ç‰ˆ helper ç²å– Buffer\n      const binaryData = await this.helpers.getBinaryDataBuffer(i, binaryKeys[0]);\n      \n      // 3. è½‰æˆ Base64 ä¸¦å­˜å…¥ JSON\n      items[i].json.raw_base64 = binaryData.toString('base64');\n      \n      // é€™è£¡åšå€‹å°æ¨™è¨˜ï¼Œæ–¹ä¾¿ä½  debug çœ‹åˆ°åœ–ç‰‡é•·åº¦\n      items[i].json.image_packed = \"Success (len: \" + items[i].json.raw_base64.length + \")\";\n    } else {\n      items[i].json.image_packed = \"Error: No binary data found in this item\";\n    }\n  } catch (error) {\n    items[i].json.image_packed = \"Error: \" + error.message;\n  }\n}\n\nreturn items;"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3184,
        -464
      ],
      "id": "a689be77-7e44-429a-b8b2-1ae726bf816a",
      "name": "Code in JavaScript5"
    },
    {
      "parameters": {
        "mode": "raw",
        "jsonOutput": "{\n  \"nodes\": [\n    {\n      \"parameters\": {\n        \"mode\": \"manual\",\n        \"includeOtherFields\": true,\n        \"fields\": {\n          \"values\": [\n            {\n              \"name\": \"original_image_base64\",\n              \"stringValue\": \"={{ $binary.data.data.toString('base64') }}\"\n            }\n          ]\n        }\n      },\n      \"id\": \"pass-original-image\",\n      \"name\": \"Pass Original Image\",\n      \"type\": \"n8n-nodes-base.set\",\n      \"typeVersion\": 3,\n      \"position\": [800, 300]\n    }\n  ]\n}",
        "includeOtherFields": true,
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1888,
        -320
      ],
      "id": "7f1a2985-356b-43c4-aa11-c3a4793f2e6d",
      "name": "Pass Original Image"
    }
  ],
  "pinData": {},
  "connections": {
    "Schedule Trigger": {
      "main": [
        [
          {
            "node": "Code in JavaScript2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript": {
      "main": [
        [
          {
            "node": "debug2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sort": {
      "main": [
        [
          {
            "node": "Limit",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Limit": {
      "main": [
        [
          {
            "node": "Pass Original Image",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Replace Me": {
      "main": [
        [
          {
            "node": "Loop Over Items (Split In Batches)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript1": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Generate Meme Captions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Rank Best Caption": {
      "main": [
        [
          {
            "node": "Select Best Caption",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Captions": {
      "main": [
        [
          {
            "node": "Rank Best Caption",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Generate Meme Captions": {
      "main": [
        [
          {
            "node": "Parse Captions",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Best Caption": {
      "main": [
        [
          {
            "node": "Code in JavaScript3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Create Meme with PIL": {
      "main": [
        [
          {
            "node": "debug",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram - Publish Media": {
      "main": [
        [
          {
            "node": "Instagram - Check Status",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram - Create Media": {
      "main": [
        [
          {
            "node": "Instagram - Publish Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Instagram - Check Status": {
      "main": [
        [
          {
            "node": "Append row in sheet",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript2": {
      "main": [
        [
          {
            "node": "Google drive",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Items (Split In Batches)": {
      "main": [
        [
          {
            "node": "Code in JavaScript1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Replace Me",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google drive": {
      "main": [
        [
          {
            "node": "debug1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request2 (Ollama Vision)": {
      "main": [
        [
          {
            "node": "Parse Meme Score",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fix Base64 for Ollama": {
      "main": [
        [
          {
            "node": "debug3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Meme Score": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript3": {
      "main": [
        [
          {
            "node": "Create Meme with PIL",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Base64 to Binary": {
      "main": [
        []
      ]
    },
    "Upload to ImgBB": {
      "main": [
        [
          {
            "node": "Instagram - Create Media",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "debug": {
      "main": [
        [
          {
            "node": "Upload to ImgBB",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "debug1": {
      "main": [
        [
          {
            "node": "Code in JavaScript",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "debug2": {
      "main": [
        [
          {
            "node": "Sort",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "debug3": {
      "main": [
        [
          {
            "node": "Code in JavaScript5",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request1": {
      "main": [
        [
          {
            "node": "Fix Base64 for Ollama",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code in JavaScript5": {
      "main": [
        [
          {
            "node": "HTTP Request2 (Ollama Vision)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Pass Original Image": {
      "main": [
        [
          {
            "node": "Loop Over Items (Split In Batches)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f035a0fd-5906-460a-9dd6-b7b7661c83ea",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "d0c1bf24d13c76f61b42dc2407c4ec8e50557d17a30965864d4592cb251ed06e"
  },
  "id": "zbgi7Yqi2V7eDSSS",
  "tags": []
}